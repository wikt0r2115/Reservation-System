<!doctype html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <title>Panel uzytkownikow</title>

    <!-- Bootstrap -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >

    <style>
        body {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand">Log service – uzytkownicy</span>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Lista uzytkownikow</h2>
    </div>

    <!-- Wiadomosc (błędy / sukcesy) -->
    <div id="message" class="mb-3"></div>

    <!-- TABELA UZYTKOWNIKOW -->
    <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Login</th>
            <th>Haslo</th>
            <th>Czy admin</th>
            <th>Akcje</th>
        </tr>
        </thead>
        <tbody id="usersBody">
        <!-- wiersze wstrzyknie JS -->
        </tbody>
    </table>

    <hr class="my-4">

    <h3 class="mb-3">Dodaj nowego uzytkownika</h3>

    <!-- FORMULARZ DODAWANIA -->
    <form id="addForm" class="row g-3">

        <div class="col-md-4">
            <label class="form-label">Login</label>
            <input type="text" class="form-control" id="login" required>
        </div>

        <div class="col-md-4">
            <label class="form-label">Haslo</label>
            <input type="password" class="form-control" id="password" required>
        </div>

        <div class="col-md-4 d-flex align-items-center">
            <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="privileges">
                <label class="form-check-label" for="privileges">
                    Administrator (privileges = true)
                </label>
            </div>
        </div>

        <div class="col-12">
            <button type="submit" class="btn btn-primary">Dodaj uzytkownika</button>
        </div>
    </form>

</div>

<script>
    // Zakladam, ze frontend jest hostowany przez ten sam serwer co backend
    // i mapping w kontrolerze to @RequestMapping("/users")
    const API_URL = "/users";

    document.addEventListener("DOMContentLoaded", loadUsers);

    function loadUsers() {
        fetch(API_URL)
            .then(res => {
                if (!res.ok) {
                    throw new Error("HTTP " + res.status);
                }
                return res.json();
            })
            .then(data => renderUsers(data))
            .catch(err => showMessage("Blad podczas pobierania uzytkownikow: " + err.message, true));
    }

    function renderUsers(users) {
        const tbody = document.getElementById("usersBody");
        tbody.innerHTML = "";

        users.forEach(u => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${u.id ?? ""}</td>
                <td>${u.login}</td>
                <td>${u.password}</td>
                <td>${u.privileges ? "TAK" : "NIE"}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">
                        Usun
                    </button>
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    function deleteUser(id) {
        if (!confirm("Na pewno chcesz usunac uzytkownika o id = " + id + " ?")) {
            return;
        }

        fetch(`${API_URL}/${id}`, {
            method: "DELETE"
        })
            .then(res => {
                if (res.status === 204) {
                    showMessage("Uzytkownik usuniety");
                    loadUsers();
                } else if (res.status === 404) {
                    showMessage("Uzytkownik nie istnieje (404)", true);
                } else {
                    throw new Error("HTTP " + res.status);
                }
            })
            .catch(err => showMessage("Blad podczas usuwania uzytkownika: " + err.message, true));
    }

    // obsluga formularza dodawania
    document.getElementById("addForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const user = {
            login: document.getElementById("login").value,
            password: document.getElementById("password").value,
            privileges: document.getElementById("privileges").checked
        };

        fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(user)
        })
            .then(res => {
                if (res.status === 201 || res.ok) {
                    return res.json();
                } else if (res.status === 400) {
                    throw new Error("Walidacja nie powiodla sie (400)");
                } else {
                    throw new Error("HTTP " + res.status);
                }
            })
            .then(saved => {
                showMessage("Dodano uzytkownika o ID: " + saved.id);
                this.reset();
                loadUsers();
            })
            .catch(err => showMessage("Blad podczas dodawania uzytkownika: " + err.message, true));
    });

    function showMessage(text, isError = false) {
        const div = document.getElementById("message");
        div.textContent = text;
        div.className = isError ? "mb-3 text-danger" : "mb-3 text-success";
    }
</script>

</body>
</html>
